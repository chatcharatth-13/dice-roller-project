<!DOCTYPE html>
<html>
<head>
    <title>Ultimate Dice Toolkit</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1e1e1e; color: white; text-align: center; }
        input, button { padding: 10px; font-size: 16px; }
        button { background: #0078d4; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a9e; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; background: #333; margin: 5px; }
        .tab.active { background: #0078d4; }
        .section { display: none; margin-top: 20px; }
        .tile { display: inline-block; padding: 10px; margin: 5px; background: lightblue; color: black; cursor: pointer; }
        .tile.selected { background: orange; }
    </style>
</head>
<body>
    <h1>🎲 Ultimate Dice Toolkit</h1>

    <!-- Tabs -->
    <div>
        <div class="tab active" onclick="showSection('dice')">Dice Roller</div>
        <div class="tab" onclick="showSection('shutbox')">Shut the Box</div>
    </div>

    <!-- Dice Roller Section -->
    <div id="dice" class="section" style="display:block;">
        <input type="text" id="diceCommand" placeholder="e.g., roll 2d6, roll 1d20">
        <button onclick="rollDice()">Roll</button>
        <div id="diceResults">Results will appear here</div>
    </div>

    <!-- Shut the Box Section -->
    <div id="shutbox" class="section">
        <button onclick="startShutbox()">Start New Game</button>
        <button onclick="rollShutbox()">Roll Dice</button>
        <h2 id="shutboxRoll"></h2>
        <div id="shutboxTiles"></div>
        <button onclick="submitShutboxMove()">Submit Move</button>
    </div>

    <script>
        // Tab switching
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            document.querySelector(`.tab[onclick="showSection('${id}')"]`).classList.add('active');
        }

        // Dice Roller
        function rollDice() {
            const command = document.getElementById("diceCommand").value || "roll";
            fetch("/roll_custom", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("diceResults").innerText = "❌ " + data.error;
                } else {
                    document.getElementById("diceResults").innerText =
                        `🎯 Rolled: ${data.results.join(", ")} (Sum: ${data.sum})`;
                }
            });
        }

        // Shut the Box
        let shutboxRollSum = 0;
        let selectedTiles = [];

        function startShutbox() {
            fetch("/start_shutbox", { method: "POST" })
                .then(res => res.json())
                .then(data => renderShutboxTiles(data.tiles));
            document.getElementById("shutboxRoll").innerText = "";
        }

        function rollShutbox() {
            fetch("/roll_shutbox", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    shutboxRollSum = data.sum;
                    document.getElementById("shutboxRoll").innerText =
                        `You rolled: ${data.roll.join(", ")} (Sum: ${data.sum})`;
                    renderShutboxTiles(data.tiles);
                    if (!data.possible) alert("No moves possible. Game Over!");
                });
        }

        function renderShutboxTiles(tiles) {
            const container = document.getElementById("shutboxTiles");
            container.innerHTML = "";
            selectedTiles = [];
            tiles.forEach(tile => {
                const div = document.createElement("div");
                div.className = "tile";
                div.innerText = tile;
                div.onclick = () => toggleTile(tile, div);
                container.appendChild(div);
            });
        }

        function toggleTile(tile, element) {
            if (selectedTiles.includes(tile)) {
                selectedTiles = selectedTiles.filter(t => t !== tile);
                element.classList.remove("selected");
            } else {
                selectedTiles.push(tile);
                element.classList.add("selected");
            }
        }

        function submitShutboxMove() {
            fetch("/move_shutbox", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chosen_tiles: selectedTiles, roll_sum: shutboxRollSum })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    renderShutboxTiles(data.tiles);
                    if (data.win) alert("🎉 You Shut the Box!");
                }
            });
        }
    </script>
</body>
</html>